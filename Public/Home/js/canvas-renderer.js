THREE.SpriteCanvasMaterial=function(a){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(c,b){};this.setValues(a)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.clone=function(){var a=new THREE.SpriteCanvasMaterial();THREE.Material.prototype.clone.call(this,a);a.color.copy(this.color);a.program=this.program;return a};THREE.CanvasRenderer=function(aB){console.log("THREE.CanvasRenderer",THREE.REVISION);var aP=THREE.Math.smoothstep;aB=aB||{};var O=this,N,D,H,M=new THREE.Projector(),c=aB.canvas!==undefined?aB.canvas:document.createElement("canvas"),f=c.width,d=c.height,g=Math.floor(f/2),e=Math.floor(d/2),ar=0,at=0,aq=f,ap=d,aD=1,r=c.getContext("2d",{alpha:aB.alpha===true}),k=new THREE.Color(0),i=aB.alpha===true?0:1,t=1,u=0,z=null,s=null,y=null,v=null,x=null,w=[],b,W,Z,ac,af,ai=new THREE.RenderableVertex(),al=new THREE.RenderableVertex(),X,Y,aa,ab,ad,ae,ag,ah,aj,ak,am,an,m=new THREE.Color(),n=new THREE.Color(),o=new THREE.Color(),p=new THREE.Color(),q=new THREE.Color(),A=new THREE.Color(),E=new THREE.Color(),G=new THREE.Color(),K={},F,V,P,Q,R,S,T,U,l=new THREE.Box2(),j=new THREE.Box2(),C=new THREE.Box2(),a=new THREE.Color(),B=new THREE.Color(),L=new THREE.Color(),ao=new THREE.Vector3(),h=new THREE.Vector3(),I=new THREE.Vector3(),J=new THREE.Matrix3();if(r.setLineDash===undefined){r.setLineDash=function(){}}this.domElement=c;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getPixelRatio=function(){return aD};this.setPixelRatio=function(aS){aD=aS};this.setSize=function(aU,aS,aT){f=aU*aD;d=aS*aD;c.width=f;c.height=d;g=Math.floor(f/2);e=Math.floor(d/2);if(aT!==false){c.style.width=aU+"px";c.style.height=aS+"px"}l.min.set(-g,-e),l.max.set(g,e);j.min.set(-g,-e);j.max.set(g,e);t=1;u=0;z=null;s=null;y=null;v=null;x=null;this.setViewport(0,0,aU,aS)};this.setViewport=function(aU,aV,aT,aS){ar=aU*aD;at=aV*aD;aq=aT*aD;ap=aS*aD};this.setScissor=function(){};this.enableScissorTest=function(){};this.setClearColor=function(aT,aS){k.set(aT);i=aS!==undefined?aS:1;j.min.set(-g,-e);j.max.set(g,e)};this.setClearColorHex=function(aT,aS){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(aT,aS)};this.getClearColor=function(){return k};this.getClearAlpha=function(){return i};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(j.empty()===false){j.intersect(l);j.expandByScalar(2);j.min.x=j.min.x+g;j.min.y=-j.min.y+e;j.max.x=j.max.x+g;j.max.y=-j.max.y+e;if(i<1){r.clearRect(j.min.x|0,j.max.y|0,(j.max.x-j.min.x)|0,(j.min.y-j.max.y)|0)}if(i>0){aH(THREE.NormalBlending);aN(1);aI("rgba("+Math.floor(k.r*255)+","+Math.floor(k.g*255)+","+Math.floor(k.b*255)+","+i+")");r.fillRect(j.min.x|0,j.max.y|0,(j.max.x-j.min.x)|0,(j.min.y-j.max.y)|0)}j.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(aX,aS){if(aS instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}if(this.autoClear===true){this.clear()}O.info.render.vertices=0;O.info.render.faces=0;r.setTransform(aq/f,0,0,-ap/d,ar,d-at);r.translate(g,e);N=M.projectScene(aX,aS,this.sortObjects,this.sortElements);D=N.elements;H=N.lights;b=aS;J.getNormalMatrix(aS.matrixWorldInverse);av();for(var aT=0,aU=D.length;aT<aU;aT++){var aV=D[aT];var aW=aV.material;if(aW===undefined||aW.opacity===0){continue}C.makeEmpty();if(aV instanceof THREE.RenderableSprite){W=aV;W.x*=g;W.y*=e;aG(W,aV,aW)}else{if(aV instanceof THREE.RenderableLine){W=aV.v1;Z=aV.v2;W.positionScreen.x*=g;W.positionScreen.y*=e;Z.positionScreen.x*=g;Z.positionScreen.y*=e;C.setFromPoints([W.positionScreen,Z.positionScreen]);if(l.isIntersectionBox(C)===true){aF(W,Z,aV,aW)}}else{if(aV instanceof THREE.RenderableFace){W=aV.v1;Z=aV.v2;ac=aV.v3;if(W.positionScreen.z<-1||W.positionScreen.z>1){continue}if(Z.positionScreen.z<-1||Z.positionScreen.z>1){continue}if(ac.positionScreen.z<-1||ac.positionScreen.z>1){continue}W.positionScreen.x*=g;W.positionScreen.y*=e;Z.positionScreen.x*=g;Z.positionScreen.y*=e;ac.positionScreen.x*=g;ac.positionScreen.y*=e;if(aW.overdraw>0){ay(W.positionScreen,Z.positionScreen,aW.overdraw);ay(Z.positionScreen,ac.positionScreen,aW.overdraw);ay(ac.positionScreen,W.positionScreen,aW.overdraw)}C.setFromPoints([W.positionScreen,Z.positionScreen,ac.positionScreen]);if(l.isIntersectionBox(C)===true){aE(W,Z,ac,0,1,2,aV,aW)}}}}j.union(C)}r.setTransform(1,0,0,1,0,0)};function av(){a.setRGB(0,0,0);B.setRGB(0,0,0);L.setRGB(0,0,0);for(var aS=0,aV=H.length;aS<aV;aS++){var aT=H[aS];var aU=aT.color;if(aT instanceof THREE.AmbientLight){a.add(aU)}else{if(aT instanceof THREE.DirectionalLight){B.add(aU)}else{if(aT instanceof THREE.PointLight){L.add(aU)}}}}}function au(aZ,aY,aT){for(var aU=0,aX=H.length;aU<aX;aU++){var aV=H[aU];G.copy(aV.color);if(aV instanceof THREE.DirectionalLight){var aW=ao.setFromMatrixPosition(aV.matrixWorld).normalize();var aS=aY.dot(aW);if(aS<=0){continue}aS*=aV.intensity;aT.add(G.multiplyScalar(aS))}else{if(aV instanceof THREE.PointLight){var aW=ao.setFromMatrixPosition(aV.matrixWorld);var aS=aY.dot(ao.subVectors(aW,aZ).normalize());if(aS<=0){continue}aS*=aV.distance==0?1:1-Math.min(aZ.distanceTo(aW)/aV.distance,1);if(aS==0){continue}aS*=aV.intensity;aT.add(G.multiplyScalar(aS))}}}}function aG(a6,aW,aX){aN(aX.opacity);aH(aX.blending);var a1=aW.scale.x*g;var a2=aW.scale.y*e;var aV=0.5*Math.sqrt(a1*a1+a2*a2);C.min.set(a6.x-aV,a6.y-aV);C.max.set(a6.x+aV,a6.y+aV);if(aX instanceof THREE.SpriteMaterial){var a5=aX.map;if(a5!==null&&a5.image!==undefined){if(a5.hasEventListener("update",aA)===false){if(a5.image.width>0){aR(a5)}a5.addEventListener("update",aA)}var a0=K[a5.id];if(a0!==undefined){aI(a0)}else{aI("rgba( 0, 0, 0, 1 )")}var aS=a5.image;var aY=aS.width*a5.offset.x;var aZ=aS.height*a5.offset.y;var a3=aS.width*a5.repeat.x;var a4=aS.height*a5.repeat.y;var aT=a1/a3;var aU=a2/a4;r.save();r.translate(a6.x,a6.y);if(aX.rotation!==0){r.rotate(aX.rotation)}r.translate(-a1/2,-a2/2);r.scale(aT,aU);r.translate(-aY,-aZ);r.fillRect(aY,aZ,a3,a4);r.restore()}else{aI(aX.color.getStyle());r.save();r.translate(a6.x,a6.y);if(aX.rotation!==0){r.rotate(aX.rotation)}r.scale(a1,-a2);r.fillRect(-0.5,-0.5,1,1);r.restore()}}else{if(aX instanceof THREE.SpriteCanvasMaterial){aO(aX.color.getStyle());aI(aX.color.getStyle());r.save();r.translate(a6.x,a6.y);if(aX.rotation!==0){r.rotate(aX.rotation)}r.scale(a1,a2);aX.program(r);r.restore()}}}function aF(aY,aZ,aU,aX){aN(aX.opacity);aH(aX.blending);r.beginPath();r.moveTo(aY.positionScreen.x,aY.positionScreen.y);r.lineTo(aZ.positionScreen.x,aZ.positionScreen.y);if(aX instanceof THREE.LineBasicMaterial){aM(aX.linewidth);aJ(aX.linecap);aL(aX.linejoin);if(aX.vertexColors!==THREE.VertexColors){aO(aX.color.getStyle())}else{var aS=aU.vertexColors[0].getStyle();var aT=aU.vertexColors[1].getStyle();if(aS===aT){aO(aS)}else{try{var aW=r.createLinearGradient(aY.positionScreen.x,aY.positionScreen.y,aZ.positionScreen.x,aZ.positionScreen.y);aW.addColorStop(0,aS);aW.addColorStop(1,aT)}catch(aV){aW=aS}aO(aW)}}r.stroke();C.expandByScalar(aX.linewidth*2)}else{if(aX instanceof THREE.LineDashedMaterial){aM(aX.linewidth);aJ(aX.linecap);aL(aX.linejoin);aO(aX.color.getStyle());aK([aX.dashSize,aX.gapSize]);r.stroke();C.expandByScalar(aX.linewidth*2);aK([])}}}function aE(aY,aZ,a0,aV,aW,aX,aS,aU){O.info.render.vertices+=3;O.info.render.faces++;aN(aU.opacity);aH(aU.blending);X=aY.positionScreen.x;Y=aY.positionScreen.y;aa=aZ.positionScreen.x;ab=aZ.positionScreen.y;ad=a0.positionScreen.x;ae=a0.positionScreen.y;ax(X,Y,aa,ab,ad,ae);if((aU instanceof THREE.MeshLambertMaterial||aU instanceof THREE.MeshPhongMaterial)&&aU.map===null){A.copy(aU.color);E.copy(aU.emissive);if(aU.vertexColors===THREE.FaceColors){A.multiply(aS.color)}m.copy(a);h.copy(aY.positionWorld).add(aZ.positionWorld).add(a0.positionWorld).divideScalar(3);au(h,aS.normalModel,m);m.multiply(A).add(E);aU.wireframe===true?aQ(m,aU.wireframeLinewidth,aU.wireframeLinecap,aU.wireframeLinejoin):az(m)}else{if(aU instanceof THREE.MeshBasicMaterial||aU instanceof THREE.MeshLambertMaterial||aU instanceof THREE.MeshPhongMaterial){if(aU.map!==null){var aT=aU.map.mapping;if(aT===THREE.UVMapping){V=aS.uvs;aC(X,Y,aa,ab,ad,ae,V[aV].x,V[aV].y,V[aW].x,V[aW].y,V[aX].x,V[aX].y,aU.map)}}else{if(aU.envMap!==null){if(aU.envMap.mapping===THREE.SphericalReflectionMapping){I.copy(aS.vertexNormalsModel[aV]).applyMatrix3(J);P=0.5*I.x+0.5;Q=0.5*I.y+0.5;I.copy(aS.vertexNormalsModel[aW]).applyMatrix3(J);R=0.5*I.x+0.5;S=0.5*I.y+0.5;I.copy(aS.vertexNormalsModel[aX]).applyMatrix3(J);T=0.5*I.x+0.5;U=0.5*I.y+0.5;aC(X,Y,aa,ab,ad,ae,P,Q,R,S,T,U,aU.envMap)}}else{m.copy(aU.color);if(aU.vertexColors===THREE.FaceColors){m.multiply(aS.color)}aU.wireframe===true?aQ(m,aU.wireframeLinewidth,aU.wireframeLinecap,aU.wireframeLinejoin):az(m)}}}else{if(aU instanceof THREE.MeshDepthMaterial){m.r=m.g=m.b=1-aP(aY.positionScreen.z*aY.positionScreen.w,b.near,b.far);aU.wireframe===true?aQ(m,aU.wireframeLinewidth,aU.wireframeLinecap,aU.wireframeLinejoin):az(m)}else{if(aU instanceof THREE.MeshNormalMaterial){I.copy(aS.normalModel).applyMatrix3(J);m.setRGB(I.x,I.y,I.z).multiplyScalar(0.5).addScalar(0.5);aU.wireframe===true?aQ(m,aU.wireframeLinewidth,aU.wireframeLinecap,aU.wireframeLinejoin):az(m)}else{m.setRGB(1,1,1);aU.wireframe===true?aQ(m,aU.wireframeLinewidth,aU.wireframeLinecap,aU.wireframeLinejoin):az(m)}}}}}function ax(aS,aV,aT,aW,aU,aX){r.beginPath();r.moveTo(aS,aV);r.lineTo(aT,aW);r.lineTo(aU,aX);r.closePath()}function aQ(aS,aV,aT,aU){aM(aV);aJ(aT);aL(aU);aO(aS.getStyle());r.stroke();C.expandByScalar(aV*2)}function az(aS){aI(aS.getStyle());r.fill()}function aA(aS){aR(aS.target)}function aR(aX){if(aX instanceof THREE.CompressedTexture){return}var aV=aX.wrapS===THREE.RepeatWrapping;var aW=aX.wrapT===THREE.RepeatWrapping;var aU=aX.image;var aS=document.createElement("canvas");aS.width=aU.width;aS.height=aU.height;var aT=aS.getContext("2d");aT.setTransform(1,0,0,-1,0,aU.height);aT.drawImage(aU,0,0);K[aX.id]=r.createPattern(aS,aV===true&&aW===true?"repeat":aV===true&&aW===false?"repeat-x":aV===false&&aW===true?"repeat-y":"no-repeat")}function aC(bc,bf,bd,bg,be,bh,a5,a8,a6,a9,a7,ba,a4){if(a4 instanceof THREE.DataTexture){return}if(a4.hasEventListener("update",aA)===false){if(a4.image!==undefined&&a4.image.width>0){aR(a4)}a4.addEventListener("update",aA)}var a3=K[a4.id];if(a3!==undefined){aI(a3)}else{aI("rgba(0,0,0,1)");r.fill();return}var aS,aT,aU,aV,aX,aY,aW,a0,a1=a4.offset.x/a4.repeat.x,a2=a4.offset.y/a4.repeat.y,bb=a4.image.width*a4.repeat.x,aZ=a4.image.height*a4.repeat.y;a5=(a5+a1)*bb;a8=(a8+a2)*aZ;a6=(a6+a1)*bb;a9=(a9+a2)*aZ;a7=(a7+a1)*bb;ba=(ba+a2)*aZ;bd-=bc;bg-=bf;be-=bc;bh-=bf;a6-=a5;a9-=a8;a7-=a5;ba-=a8;aW=a6*ba-a7*a9;if(aW===0){return}a0=1/aW;aS=(ba*bd-a9*be)*a0;aT=(ba*bg-a9*bh)*a0;aU=(a6*be-a7*bd)*a0;aV=(a6*bh-a7*bg)*a0;aX=bc-aS*a5-aU*a8;aY=bf-aT*a5-aV*a8;r.save();r.transform(aS,aT,aU,aV,aX,aY);r.fill();r.restore()}function aw(a9,bc,ba,bd,bb,be,a2,a5,a3,a6,a4,a7,a1){var aS,aT,aU,aV,aX,aY,aW,a0,a8=a1.width-1,aZ=a1.height-1;a2*=a8;a5*=aZ;a3*=a8;a6*=aZ;a4*=a8;a7*=aZ;ba-=a9;bd-=bc;bb-=a9;be-=bc;a3-=a2;a6-=a5;a4-=a2;a7-=a5;aW=a3*a7-a4*a6;a0=1/aW;aS=(a7*ba-a6*bb)*a0;aT=(a7*bd-a6*be)*a0;aU=(a3*bb-a4*ba)*a0;aV=(a3*be-a4*bd)*a0;aX=a9-aS*a2-aU*a5;aY=bc-aT*a2-aV*a5;r.save();r.transform(aS,aT,aU,aV,aX,aY);r.clip();r.drawImage(a1,0,0);r.restore()}function ay(aV,aW,aU){var aX=aW.x-aV.x,aY=aW.y-aV.y,aS=aX*aX+aY*aY,aT;if(aS===0){return}aT=aU/Math.sqrt(aS);aX*=aT;aY*=aT;aW.x+=aX;aW.y+=aY;aV.x-=aX;aV.y-=aY}function aN(aS){if(t!==aS){r.globalAlpha=aS;t=aS}}function aH(aS){if(u!==aS){if(aS===THREE.NormalBlending){r.globalCompositeOperation="source-over"}else{if(aS===THREE.AdditiveBlending){r.globalCompositeOperation="lighter"}else{if(aS===THREE.SubtractiveBlending){r.globalCompositeOperation="darker"}}}u=aS}}function aM(aS){if(y!==aS){r.lineWidth=aS;y=aS}}function aJ(aS){if(v!==aS){r.lineCap=aS;v=aS}}function aL(aS){if(x!==aS){r.lineJoin=aS;x=aS}}function aO(aS){if(z!==aS){r.strokeStyle=aS;z=aS}}function aI(aS){if(s!==aS){r.fillStyle=aS;s=aS}}function aK(aS){if(w.length!==aS.length){r.setLineDash(aS);w=aS}}};