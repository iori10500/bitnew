THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.v3=new THREE.RenderableVertex();this.normalModel=new THREE.Vector3();this.vertexNormalsModel=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];this.vertexNormalsLength=0;this.color=new THREE.Color();this.material=null;this.uvs=[new THREE.Vector2(),new THREE.Vector2(),new THREE.Vector2()];this.z=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3();this.positionWorld=new THREE.Vector3();this.positionScreen=new THREE.Vector4();this.visible=true};THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld);this.positionScreen.copy(a.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.vertexColors=[new THREE.Color(),new THREE.Color()];this.material=null;this.z=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2();this.material=null};THREE.Projector=function(){var q,r,s=[],t=0,D,E,F=[],G=0,e,f,g=[],h=0,j,k,l=[],m=0,x,y,z=[],A=0,w={objects:[],lights:[],elements:[]},B=new THREE.Vector3(),C=new THREE.Vector4(),b=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),a=new THREE.Box3(),u=new Array(3),v=new Array(4),H=new THREE.Matrix4(),I=new THREE.Matrix4(),n,o=new THREE.Matrix4(),p=new THREE.Matrix3(),i=new THREE.Frustum(),c=new THREE.Vector4(),d=new THREE.Vector4();this.projectVector=function(T,S){console.warn("THREE.Projector: .projectVector() is now vector.project().");T.project(S)};this.unprojectVector=function(T,S){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");T.unproject(S)};this.pickingRay=function(T,S){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var R=function(){var W=[];var af=[];var X=null;var U=null;var V=new THREE.Matrix3();var ae=function(ag){X=ag;U=X.material;V.getNormalMatrix(X.matrixWorld);W.length=0;af.length=0};var Y=function(ak){var ah=ak.position;var aj=ak.positionWorld;var ai=ak.positionScreen;aj.copy(ah).applyMatrix4(n);ai.copy(aj).applyMatrix4(I);var ag=1/ai.w;ai.x*=ag;ai.y*=ag;ai.z*=ag;ak.visible=ai.x>=-1&&ai.x<=1&&ai.y>=-1&&ai.y<=1&&ai.z>=-1&&ai.z<=1};var ad=function(ag,ah,ai){D=O();D.position.set(ag,ah,ai);Y(D)};var aa=function(ag,ah,ai){W.push(ag,ah,ai)};var ac=function(ag,ah){af.push(ag,ah)};var T=function(ag,ah,ai){if(ag.visible===true||ah.visible===true||ai.visible===true){return true}u[0]=ag.positionScreen;u[1]=ah.positionScreen;u[2]=ai.positionScreen;return b.isIntersectionBox(a.setFromPoints(u))};var S=function(ag,ah,ai){return((ai.positionScreen.x-ag.positionScreen.x)*(ah.positionScreen.y-ag.positionScreen.y)-(ai.positionScreen.y-ag.positionScreen.y)*(ah.positionScreen.x-ag.positionScreen.x))<0};var Z=function(ag,ah){var ai=F[ag];var aj=F[ah];j=L();j.id=X.id;j.v1.copy(ai);j.v2.copy(aj);j.z=(ai.positionScreen.z+aj.positionScreen.z)/2;j.material=X.material;w.elements.push(j)};var ab=function(ag,ah,ai){var ao=F[ag];var ap=F[ah];var aq=F[ai];if(T(ao,ap,aq)===false){return}if(U.side===THREE.DoubleSide||S(ao,ap,aq)===true){e=K();e.id=X.id;e.v1.copy(ao);e.v2.copy(ap);e.v3.copy(aq);e.z=(ao.positionScreen.z+ap.positionScreen.z+aq.positionScreen.z)/3;for(var aj=0;aj<3;aj++){var al=arguments[aj]*3;var ak=e.vertexNormalsModel[aj];ak.set(W[al],W[al+1],W[al+2]);ak.applyMatrix3(V).normalize();var am=arguments[aj]*2;var an=e.uvs[aj];an.set(af[am],af[am+1])}e.vertexNormalsLength=3;e.material=X.material;w.elements.push(e)}};return{setObject:ae,projectVertex:Y,checkTriangleVisibility:T,checkBackfaceCulling:S,pushVertex:ad,pushNormal:aa,pushUv:ac,pushLine:Z,pushTriangle:ab}};var Q=new R();this.projectScene=function(ax,T,aA,az){f=0;k=0;y=0;w.elements.length=0;if(ax.autoUpdate===true){ax.updateMatrixWorld()}if(T.parent===undefined){T.updateMatrixWorld()}H.copy(T.matrixWorldInverse.getInverse(T.matrixWorld));I.multiplyMatrices(T.projectionMatrix,H);i.setFromMatrix(I);r=0;w.objects.length=0;w.lights.length=0;ax.traverseVisible(function(aR){if(aR instanceof THREE.Light){w.lights.push(aR)}else{if(aR instanceof THREE.Mesh||aR instanceof THREE.Line||aR instanceof THREE.Sprite){if(aR.material.visible===false){return}if(aR.frustumCulled===false||i.intersectsObject(aR)===true){q=M();q.id=aR.id;q.object=aR;B.setFromMatrixPosition(aR.matrixWorld);B.applyProjection(I);q.z=B.z;w.objects.push(q)}}}});if(aA===true){w.objects.sort(P)}for(var ap=0,av=w.objects.length;ap<av;ap++){var aq=w.objects[ap].object;var aa=aq.geometry;Q.setObject(aq);n=aq.matrixWorld;E=0;if(aq instanceof THREE.Mesh){if(aa instanceof THREE.BufferGeometry){var S=aa.attributes;var au=aa.offsets;if(S.position===undefined){continue}var aw=S.position.array;for(var ab=0,ah=aw.length;ab<ah;ab+=3){Q.pushVertex(aw[ab],aw[ab+1],aw[ab+2])}if(S.normal!==undefined){var ao=S.normal.array;for(var ab=0,ah=ao.length;ab<ah;ab+=3){Q.pushNormal(ao[ab],ao[ab+1],ao[ab+2])}}if(S.uv!==undefined){var aH=S.uv.array;for(var ab=0,ah=aH.length;ab<ah;ab+=2){Q.pushUv(aH[ab],aH[ab+1])}}if(S.index!==undefined){var ad=S.index.array;if(au.length>0){for(var ap=0;ap<au.length;ap++){var at=au[ap];var ac=at.index;for(var ab=at.start,ah=at.start+at.count;ab<ah;ab+=3){Q.pushTriangle(ad[ab]+ac,ad[ab+1]+ac,ad[ab+2]+ac)}}}else{for(var ab=0,ah=ad.length;ab<ah;ab+=3){Q.pushTriangle(ad[ab],ad[ab+1],ad[ab+2])}}}else{for(var ab=0,ah=aw.length/3;ab<ah;ab+=3){Q.pushTriangle(ab,ab+1,ab+2)}}}else{if(aa instanceof THREE.Geometry){var aO=aa.vertices;var W=aa.faces;var Y=aa.faceVertexUvs[0];p.getNormalMatrix(n);var ai=aq.material;var ag=ai instanceof THREE.MeshFaceMaterial;var ar=ag===true?aq.material:null;for(var aI=0,aQ=aO.length;aI<aQ;aI++){var aM=aO[aI];B.copy(aM);if(ai.morphTargets===true){var ak=aa.morphTargets;var aj=aq.morphTargetInfluences;for(var aC=0,aF=ak.length;aC<aF;aC++){var ae=aj[aC];if(ae===0){continue}var aD=ak[aC];var aE=aD.vertices[aI];B.x+=(aE.x-aM.x)*ae;B.y+=(aE.y-aM.y)*ae;B.z+=(aE.z-aM.z)*ae}}Q.pushVertex(B.x,B.y,B.z)}for(var U=0,Z=W.length;U<Z;U++){var V=W[U];var ai=ag===true?ar.materials[V.materialIndex]:aq.material;if(ai===undefined){continue}var ay=ai.side;var aJ=F[V.a];var aK=F[V.b];var aL=F[V.c];if(Q.checkTriangleVisibility(aJ,aK,aL)===false){continue}var aP=Q.checkBackfaceCulling(aJ,aK,aL);if(ay!==THREE.DoubleSide){if(ay===THREE.FrontSide&&aP===false){continue}if(ay===THREE.BackSide&&aP===true){continue}}e=K();e.id=aq.id;e.v1.copy(aJ);e.v2.copy(aK);e.v3.copy(aL);e.normalModel.copy(V.normal);if(aP===false&&(ay===THREE.BackSide||ay===THREE.DoubleSide)){e.normalModel.negate()}e.normalModel.applyMatrix3(p).normalize();var X=V.vertexNormals;for(var al=0,am=Math.min(X.length,3);al<am;al++){var an=e.vertexNormalsModel[al];an.copy(X[al]);if(aP===false&&(ay===THREE.BackSide||ay===THREE.DoubleSide)){an.negate()}an.applyMatrix3(p).normalize()}e.vertexNormalsLength=X.length;var aN=Y[U];if(aN!==undefined){for(var aG=0;aG<3;aG++){e.uvs[aG].copy(aN[aG])}}e.color=V.color;e.material=ai;e.z=(aJ.positionScreen.z+aK.positionScreen.z+aL.positionScreen.z)/3;w.elements.push(e)}}}}else{if(aq instanceof THREE.Line){if(aa instanceof THREE.BufferGeometry){var S=aa.attributes;if(S.position!==undefined){var aw=S.position.array;for(var ab=0,ah=aw.length;ab<ah;ab+=3){Q.pushVertex(aw[ab],aw[ab+1],aw[ab+2])}if(S.index!==undefined){var ad=S.index.array;for(var ab=0,ah=ad.length;ab<ah;ab+=2){Q.pushLine(ad[ab],ad[ab+1])}}else{var aB=aq.mode===THREE.LinePieces?2:1;for(var ab=0,ah=(aw.length/3)-1;ab<ah;ab+=aB){Q.pushLine(ab,ab+1)}}}}else{if(aa instanceof THREE.Geometry){o.multiplyMatrices(I,n);var aO=aq.geometry.vertices;if(aO.length===0){continue}aJ=O();aJ.positionScreen.copy(aO[0]).applyMatrix4(o);var aB=aq.mode===THREE.LinePieces?2:1;for(var aI=1,aQ=aO.length;aI<aQ;aI++){aJ=O();aJ.positionScreen.copy(aO[aI]).applyMatrix4(o);if((aI+1)%aB>0){continue}aK=F[E-2];c.copy(aJ.positionScreen);d.copy(aK.positionScreen);if(J(c,d)===true){c.multiplyScalar(1/c.w);d.multiplyScalar(1/d.w);j=L();j.id=aq.id;j.v1.positionScreen.copy(c);j.v2.positionScreen.copy(d);j.z=Math.max(c.z,d.z);j.material=aq.material;if(aq.material.vertexColors===THREE.VertexColors){j.vertexColors[0].copy(aq.geometry.colors[aI]);j.vertexColors[1].copy(aq.geometry.colors[aI-1])}w.elements.push(j)}}}}}else{if(aq instanceof THREE.Sprite){C.set(n.elements[12],n.elements[13],n.elements[14],1);C.applyMatrix4(I);var af=1/C.w;C.z*=af;if(C.z>=-1&&C.z<=1){x=N();x.id=aq.id;x.x=C.x*af;x.y=C.y*af;x.z=C.z;x.object=aq;x.rotation=aq.rotation;x.scale.x=aq.scale.x*Math.abs(x.x-(C.x+T.projectionMatrix.elements[0])/(C.w+T.projectionMatrix.elements[12]));x.scale.y=aq.scale.y*Math.abs(x.y-(C.y+T.projectionMatrix.elements[5])/(C.w+T.projectionMatrix.elements[13]));x.material=aq.material;w.elements.push(x)}}}}}if(az===true){w.elements.sort(P)}return w};function M(){if(r===t){var S=new THREE.RenderableObject();s.push(S);t++;r++;return S}return s[r++]}function O(){if(E===G){var S=new THREE.RenderableVertex();F.push(S);G++;E++;return S}return F[E++]}function K(){if(f===h){var S=new THREE.RenderableFace();g.push(S);h++;f++;return S}return g[f++]}function L(){if(k===m){var S=new THREE.RenderableLine();l.push(S);m++;k++;return S}return l[k++]}function N(){if(y===A){var S=new THREE.RenderableSprite();z.push(S);A++;y++;return S}return z[y++]}function P(S,T){if(S.z!==T.z){return T.z-S.z}else{if(S.id!==T.id){return S.id-T.id}else{return 0}}}function J(Y,Z){var S=0,T=1,V=Y.z+Y.w,X=Z.z+Z.w,U=-Y.z+Y.w,W=-Z.z+Z.w;if(V>=0&&X>=0&&U>=0&&W>=0){return true}else{if((V<0&&X<0)||(U<0&&W<0)){return false}else{if(V<0){S=Math.max(S,V/(V-X))}else{if(X<0){T=Math.min(T,V/(V-X))}}if(U<0){S=Math.max(S,U/(U-W))}else{if(W<0){T=Math.min(T,U/(U-W))}}if(T<S){return false}else{Y.lerp(Z,S);Z.lerp(Y,1-T);return true}}}}};