KindEditor.plugin("table",function(d){var h=this,f="table",e=h.lang(f+"."),i="ke-zeroborder";function c(j,k){k=k.toUpperCase();j.css("background-color",k);j.css("color",k==="#000000"?"#FFFFFF":"#000000");j.html(k)}var g=[];function b(k,j){j.bind("click,mousedown",function(m){m.stopPropagation()});function l(){d.each(g,function(){this.remove()});g=[];d(document).unbind("click,mousedown",l);k.unbind("click,mousedown",l)}j.click(function(n){l();var m=d(this),p=m.pos();var o=d.colorpicker({x:p.x,y:p.y+m.height(),z:811214,selectedColor:d(this).html(),colors:h.colorTable,noColor:h.lang("noColor"),shadowMode:h.shadowMode,click:function(q){c(m,q);l()}});g.push(o);d(document).bind("click,mousedown",l);k.bind("click,mousedown",l)})}function a(o,m,j){var n=0;for(var k=0,l=m.cells.length;k<l;k++){if(m.cells[k]==j){break}n+=m.cells[k].rowSpan-1}return j.cellIndex-n}h.plugin.table={prop:function(s){var r=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+e.cells+"</label>",e.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',e.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+e.size+"</label>",e.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+e.percent+"</option>",'<option value="px">'+e.px+"</option>","</select> &nbsp; ",e.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+e.percent+"</option>",'<option value="px">'+e.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+e.space+"</label>",e.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',e.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+e.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+e.alignDefault+"</option>",'<option value="left">'+e.alignLeft+"</option>",'<option value="center">'+e.alignCenter+"</option>",'<option value="right">'+e.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+e.border+"</label>",e.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',e.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+e.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var n=h.createDialog({name:f,width:500,title:h.lang(f),body:r,beforeRemove:function(){l.unbind()},yesBtn:{name:h.lang("yes"),click:function(H){var O=v.val(),G=m.val(),R=A.val(),I=p.val(),S=B.val(),J=q.val(),N=u.val(),P=w.val(),C=j.val(),E=k.val(),F=d(l[0]).html()||"",D=d(l[1]).html()||"";if(O==0||!/^\d+$/.test(O)){alert(h.lang("invalidRows"));v[0].focus();return}if(G==0||!/^\d+$/.test(G)){alert(h.lang("invalidRows"));m[0].focus();return}if(!/^\d*$/.test(R)){alert(h.lang("invalidWidth"));A[0].focus();return}if(!/^\d*$/.test(I)){alert(h.lang("invalidHeight"));p[0].focus();return}if(!/^\d*$/.test(N)){alert(h.lang("invalidPadding"));u[0].focus();return}if(!/^\d*$/.test(P)){alert(h.lang("invalidSpacing"));w[0].focus();return}if(!/^\d*$/.test(E)){alert(h.lang("invalidBorder"));k[0].focus();return}if(x){if(R!==""){x.width(R+S)}else{x.css("width","")}if(x[0].width!==undefined){x.removeAttr("width")}if(I!==""){x.height(I+J)}else{x.css("height","")}if(x[0].height!==undefined){x.removeAttr("height")}x.css("background-color",D);if(x[0].bgColor!==undefined){x.removeAttr("bgColor")}if(N!==""){x[0].cellPadding=N}else{x.removeAttr("cellPadding")}if(P!==""){x[0].cellSpacing=P}else{x.removeAttr("cellSpacing")}if(C!==""){x[0].align=C}else{x.removeAttr("align")}if(E!==""){x.attr("border",E)}else{x.removeAttr("border")}if(E===""||E==="0"){x.addClass(i)}else{x.removeClass(i)}if(F!==""){x.attr("borderColor",F)}else{x.removeAttr("borderColor")}h.hideDialog().focus();return}var Q="";if(R!==""){Q+="width:"+R+S+";"}if(I!==""){Q+="height:"+I+J+";"}if(D!==""){Q+="background-color:"+D+";"}var K="<table";if(Q!==""){K+=' style="'+Q+'"'}if(N!==""){K+=' cellpadding="'+N+'"'}if(P!==""){K+=' cellspacing="'+P+'"'}if(C!==""){K+=' align="'+C+'"'}if(E!==""){K+=' border="'+E+'"'}if(E===""||E==="0"){K+=' class="'+i+'"'}if(F!==""){K+=' bordercolor="'+F+'"'}K+=">";for(var L=0;L<O;L++){K+="<tr>";for(var M=0;M<G;M++){K+="<td>"+(d.IE?"&nbsp;":"<br />")+"</td>"}K+="</tr>"}K+="</table>";if(!d.IE){K+="<br />"}h.insertHtml(K);h.select().hideDialog().focus();h.addBookmark()}}}),o=n.div,v=d('[name="rows"]',o).val(3),m=d('[name="cols"]',o).val(2),A=d('[name="width"]',o).val(100),p=d('[name="height"]',o),B=d('[name="widthType"]',o),q=d('[name="heightType"]',o),u=d('[name="padding"]',o).val(2),w=d('[name="spacing"]',o).val(0),j=d('[name="align"]',o),k=d('[name="border"]',o).val(1),l=d(".ke-input-color",o);b(o,l.eq(0));b(o,l.eq(1));c(l.eq(0),"#000000");c(l.eq(1),"");v[0].focus();v[0].select();var x;if(s){return}x=h.plugin.getSelectedTable();if(x){v.val(x[0].rows.length);m.val(x[0].rows.length>0?x[0].rows[0].cells.length:0);v.attr("disabled",true);m.attr("disabled",true);var t,z=x[0].style.width||x[0].width,y=x[0].style.height||x[0].height;if(z!==undefined&&(t=/^(\d+)((?:px|%)*)$/.exec(z))){A.val(t[1]);B.val(t[2])}else{A.val("")}if(y!==undefined&&(t=/^(\d+)((?:px|%)*)$/.exec(y))){p.val(t[1]);q.val(t[2])}u.val(x[0].cellPadding||"");w.val(x[0].cellSpacing||"");j.val(x[0].align||"");k.val(x[0].border===undefined?"":x[0].border);c(l.eq(0),d.toHex(x.attr("borderColor")||""));c(l.eq(1),d.toHex(x[0].style.backgroundColor||x[0].bgColor||""));A[0].focus();A[0].select()}},cellprop:function(){var t=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+e.size+"</label>",e.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+e.percent+"</option>",'<option value="px">'+e.px+"</option>","</select> &nbsp; ",e.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+e.percent+"</option>",'<option value="px">'+e.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+e.align+"</label>",e.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+e.alignDefault+"</option>",'<option value="left">'+e.alignLeft+"</option>",'<option value="center">'+e.alignCenter+"</option>",'<option value="right">'+e.alignRight+"</option>","</select> ",e.verticalAlign+' <select name="verticalAlign">','<option value="">'+e.alignDefault+"</option>",'<option value="top">'+e.alignTop+"</option>",'<option value="middle">'+e.alignMiddle+"</option>",'<option value="bottom">'+e.alignBottom+"</option>",'<option value="baseline">'+e.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+e.border+"</label>",e.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',e.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+e.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var p=h.createDialog({name:f,width:500,title:h.lang("tablecell"),body:t,beforeRemove:function(){o.unbind()},yesBtn:{name:h.lang("yes"),click:function(E){var L=z.val(),F=r.val(),M=A.val(),G=s.val(),H=v.val(),I=w.val(),J=x.val(),K=y.val(),C=k.val(),D=d(o[0]).html()||"",B=d(o[1]).html()||"";if(!/^\d*$/.test(L)){alert(h.lang("invalidWidth"));z[0].focus();return}if(!/^\d*$/.test(F)){alert(h.lang("invalidHeight"));r[0].focus();return}if(!/^\d*$/.test(C)){alert(h.lang("invalidBorder"));k[0].focus();return}l.css({width:L!==""?(L+M):"",height:F!==""?(F+G):"","background-color":B,"text-align":J,"vertical-align":K,"border-width":C,"border-style":C!==""?"solid":"","border-color":D});h.hideDialog().focus();h.addBookmark()}}}),q=p.div,z=d('[name="width"]',q).val(100),r=d('[name="height"]',q),A=d('[name="widthType"]',q),s=d('[name="heightType"]',q),v=d('[name="padding"]',q).val(2),w=d('[name="spacing"]',q).val(0),x=d('[name="textAlign"]',q),y=d('[name="verticalAlign"]',q),k=d('[name="border"]',q).val(1),o=d(".ke-input-color",q);b(q,o.eq(0));b(q,o.eq(1));c(o.eq(0),"#000000");c(o.eq(1),"");z[0].focus();z[0].select();var l=h.plugin.getSelectedCell();var u,n=l[0].style.width||l[0].width||"",m=l[0].style.height||l[0].height||"";if((u=/^(\d+)((?:px|%)*)$/.exec(n))){z.val(u[1]);A.val(u[2])}else{z.val("")}if((u=/^(\d+)((?:px|%)*)$/.exec(m))){r.val(u[1]);s.val(u[2])}x.val(l[0].style.textAlign||"");y.val(l[0].style.verticalAlign||"");var j=l[0].style.borderWidth||"";if(j){j=parseInt(j)}k.val(j);c(o.eq(0),d.toHex(l[0].style.borderColor||""));c(o.eq(1),d.toHex(l[0].style.backgroundColor||""));z[0].focus();z[0].select()},insert:function(){this.prop(true)},"delete":function(){var j=h.plugin.getSelectedTable();h.cmd.range.setStartBefore(j[0]).collapse(true);h.cmd.select();j.remove();h.addBookmark()},colinsert:function(p){var r=h.plugin.getSelectedTable()[0],q=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],l=j.cellIndex+p;l+=r.rows[0].cells.length-q.cells.length;for(var k=0,m=r.rows.length;k<m;k++){var o=r.rows[k],n=o.insertCell(l);n.innerHTML=d.IE?"":"<br />";l=a(r,o,n)}h.cmd.range.selectNodeContents(j).collapse(true);h.cmd.select();h.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(t){var w=h.plugin.getSelectedTable()[0],u=h.plugin.getSelectedRow()[0],l=h.plugin.getSelectedCell()[0];var v=u.rowIndex;if(t===1){v=u.rowIndex+(l.rowSpan-1)+t}var s=w.insertRow(v);for(var n=0,q=u.cells.length;n<q;n++){if(u.cells[n].rowSpan>1){q-=u.cells[n].rowSpan-1}var r=s.insertCell(n);if(t===1&&u.cells[n].colSpan>1){r.colSpan=u.cells[n].colSpan}r.innerHTML=d.IE?"":"<br />"}for(var o=v;o>=0;o--){var m=w.rows[o].cells;if(m.length>n){for(var p=l.cellIndex;p>=0;p--){if(m[p].rowSpan>1){m[p].rowSpan+=1}}break}}h.cmd.range.selectNodeContents(l).collapse(true);h.cmd.select();h.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var q=h.plugin.getSelectedTable()[0],o=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],p=o.rowIndex,n=p+j.rowSpan,m=q.rows[n];if(q.rows.length<=n){return}var k=a(q,o,j);if(m.cells.length<=k){return}var l=m.cells[k];if(j.colSpan!==l.colSpan){return}j.rowSpan+=l.rowSpan;m.deleteCell(k);h.cmd.range.selectNodeContents(j).collapse(true);h.cmd.select();h.addBookmark()},colmerge:function(){var p=h.plugin.getSelectedTable()[0],n=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],o=n.rowIndex,k=j.cellIndex,m=k+1;if(n.cells.length<=m){return}var l=n.cells[m];if(j.rowSpan!==l.rowSpan){return}j.colSpan+=l.colSpan;n.deleteCell(m);h.cmd.range.selectNodeContents(j).collapse(true);h.cmd.select();h.addBookmark()},rowsplit:function(){var r=h.plugin.getSelectedTable()[0],p=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],q=p.rowIndex;if(j.rowSpan===1){return}var k=a(r,p,j);for(var l=1,m=j.rowSpan;l<m;l++){var o=r.rows[q+l],n=o.insertCell(k);if(j.colSpan>1){n.colSpan=j.colSpan}n.innerHTML=d.IE?"":"<br />";k=a(r,o,n)}d(j).removeAttr("rowSpan");h.cmd.range.selectNodeContents(j).collapse(true);h.cmd.select();h.addBookmark()},colsplit:function(){var p=h.plugin.getSelectedTable()[0],o=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],k=j.cellIndex;if(j.colSpan===1){return}for(var l=1,m=j.colSpan;l<m;l++){var n=o.insertCell(k+l);if(j.rowSpan>1){n.rowSpan=j.rowSpan}n.innerHTML=d.IE?"":"<br />"}d(j).removeAttr("colSpan");h.cmd.range.selectNodeContents(j).collapse(true);h.cmd.select();h.addBookmark()},coldelete:function(){var q=h.plugin.getSelectedTable()[0],p=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],l=j.cellIndex;for(var k=0,m=q.rows.length;k<m;k++){var o=q.rows[k],n=o.cells[l];if(n.colSpan>1){n.colSpan-=1;if(n.colSpan===1){d(n).removeAttr("colSpan")}}else{o.deleteCell(l)}if(n.rowSpan>1){k+=n.rowSpan-1}}if(p.cells.length===0){h.cmd.range.setStartBefore(q).collapse(true);h.cmd.select();d(q).remove()}else{h.cmd.selection(true)}h.addBookmark()},rowdelete:function(){var n=h.plugin.getSelectedTable()[0],l=h.plugin.getSelectedRow()[0],j=h.plugin.getSelectedCell()[0],m=l.rowIndex;for(var k=j.rowSpan-1;k>=0;k--){n.deleteRow(m+k)}if(n.rows.length===0){h.cmd.range.setStartBefore(n).collapse(true);h.cmd.select();d(n).remove()}else{h.cmd.selection(true)}h.addBookmark()}};h.clickToolbar(f,h.plugin.table.prop)});